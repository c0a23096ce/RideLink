# ライドシェアサービスの処理の流れ
## 1. ユーザー登録とログイン
ユーザーが新規登録し、Userテーブルに情報が保存されます
登録済みユーザーはログインしてサービスを利用します
## 2. 旅行リクエスト作成
ユーザーがアプリで現在地と目的地、出発予定時刻を指定します
この情報がTripRequestテーブルに保存され、statusはactiveになります
例: 東京駅から渋谷駅へ行きたいユーザーがリクエスト作成
## 3. マッチング処理
システムが現在地と目的地が近いアクティブなリクエスト同士を探索します
MatchingServiceクラスが近距離にあるTripRequestを見つけます
マッチング候補が見つかると、Matchテーブルに新しいレコードが作成されます
このとき、statusはpending（保留中）になります
例: 東京駅から恵比寿駅へ行きたい別のユーザーとマッチング
## 4. マッチング通知と承認/拒否
両ユーザーにマッチング候補の通知が送られます
ユーザーはマッチングを承認または拒否できます
承認された場合、Match.statusがacceptedに変更されます
拒否された場合、Match.statusがrejectedに変更されます
どちらの場合も、MatchHistoryテーブルに状態変更が記録されます
両方のユーザーが承認した場合、関連するTripRequest.statusがmatchedに変わります
## 5. 旅行の実行と完了
マッチングが成立したユーザー同士が実際に会って移動します
旅行が完了したら、ユーザーがアプリで完了を報告します
Match.statusがcompletedに更新されます
関連するTripRequest.statusもcompletedに更新されます
これらの変更もMatchHistoryテーブルに記録されます
## 6. キャンセルケース
ユーザーが旅行をキャンセルする場合、TripRequest.statusがcancelledになります
これに伴い、関連するMatch.statusも適切に更新されます
キャンセル理由などもMatchHistoryに記録できます
この設計により、ユーザーのリクエストからマッチング、旅行完了までの全プロセスが適切に記録され、状態管理と履歴追跡が可能になります。また、問題が発生した場合はMatchHistoryを参照して経緯を確認できます。

# シナリオ
ライドシェアサービス：具体的なシナリオ  
シナリオ：東京都内の通勤ライドシェア  
登場人物  
* 田中さん（30歳、会社員、自家用車所有）
* 佐藤さん（28歳、会社員、車なし）
* 鈴木さん（25歳、大学院生、車なし）
* 高橋さん（35歳、フリーランス、自家用車所有）
## シナリオの流れ
### 1. ユーザー登録とログイン
* 田中さんは毎朝、自宅（世田谷区）から会社（新宿区）まで車で通勤しています。ガソリン代を節約するため、ライドシェアサービスに登録しました。
* 佐藤さんは武蔵小杉駅近くに住んでおり、新宿の同じビルで働いています。通勤ラッシュを避けるため、ライドシェアサービスに登録しました。  
* 鈴木さんは世田谷区に住んでおり、恵比寿のラボに通っています。
高橋さんは自由が丘に住んでおり、不定期に渋谷のコワーキングスペースを利用しています。
* 高橋さんは自由が丘に住んでおり、不定期に渋谷のコワーキングスペースを利用しています。
### 2. 旅行リクエスト作成
- 田中さんは朝8時に出発予定で、自宅（世田谷区）から新宿までの運転ルートをシステムに登録します。  
    - TripRequest: {user_id: 1, current_location: [世田谷区座標], destination: [新宿区座標], departure_time: "2025-03-19 08:00", status: "active"}
- 同じ朝、佐藤さんは武蔵小杉から新宿までの移動手段を探しています。  
    - TripRequest: {user_id: 2, current_location: [武蔵小杉座標], destination: [新宿区座標], departure_time: "2025-03-19 08:15", status: "active"}
- 鈴木さんも同じ時間帯に世田谷区から恵比寿へのリクエストを作成します。    
    - TripRequest: {user_id: 3, current_location: [世田谷区座標], destination: [恵比寿座標], departure_time: "2025-03-19 08:20", status: "active"}  
### 3. マッチング処理
- システムは田中さんと佐藤さんの目的地が近いことを検出し、田中さんのルート上に佐藤さんの現在地（武蔵小杉）が通過点としてあることを確認します。
    - Match: {request_id1: 1, request_id2: 2, status: "pending", created_at: "2025-03-19 07:30"}
- 同様に、田中さんと鈴木さんのマッチングも提案されます（世田谷区が近く、新宿と恵比寿は同じ方向）。
    - Match: {request_id1: 1, request_id3: 3, status: "pending", created_at: "2025-03-19 07:32"}
### 4. マッチング通知と承認/拒否
- 田中さんと佐藤さんのスマートフォンにマッチング通知が届きます。
- 田中さんはマッチングを確認し、佐藤さんをピックアップすることを承認します。
    - MatchHistory: {match_id: 1, previous_status: "pending", new_status: "partial_accepted", changed_by: 1}
- 佐藤さんも通知を見て承認します。
    - MatchHistory: {match_id: 1, previous_status: "partial_accepted", new_status: "accepted", changed_by: 2}
- このマッチングが成立したため、両者のリクエストステータスが更新されます。
    - TripRequest: {id: 1, status: "matched"}
    - TripRequest: {id: 2, status: "matched"}
- 一方、鈴木さんとのマッチングについては、田中さんは既に佐藤さんとマッチングしたため、自動的に拒否されます。
    - MatchHistory: {match_id: 2, previous_status: - - "pending", new_status: "rejected", changed_by: 1}
### 5. 旅行の実行と完了
- 田中さんは朝8時に自宅を出発し、アプリの指示に従って8時15分に武蔵小杉の指定場所で佐藤さんをピックアップします。
- 二人は一緒に新宿へ向かい、8時45分に会社に到着します。
- 佐藤さんがアプリで旅行完了を報告します。
    - MatchHistory: {match_id: 1, previous_status: "accepted", new_status: "completed_by_passenger", changed_by: 2}
- 田中さんも旅行完了を確認します。
    - MatchHistory: {match_id: 1, previous_status: "completed_by_passenger", new_status: "completed", changed_by: 1}
- 両方のTripRequestが完了状態に更新されます。
    - TripRequest: {id: 1, status: "completed"}
    - TripRequest: {id: 2, status: "completed"}
### 6. キャンセルケース
- 別の日、高橋さんが自由が丘から渋谷へのリクエストを作成します。
    - TripRequest: {user_id: 4, current_location: [自由が丘座標], destination: [渋谷座標], departure_time: "2025-03-20 10:00", status: "active"}
- 鈴木さんも同じ日に世田谷から渋谷へのリクエストを作成し、マッチングが成立します。
    - Match: {request_id1: 4, request_id2: 3, status: "accepted"}
- しかし出発30分前に、高橋さんに急な仕事が入りキャンセルすることになりました。
    - TripRequest: {id: 4, status: "cancelled"}
    - MatchHistory: {match_id: 3, previous_status: "accepted", new_status: "cancelled", changed_by: 4, notes: "急な仕事が入ったため"}
- システムは鈴木さんに通知を送り、鈴木さんのリクエストは再び「active」状態に戻ります。
    - TripRequest: {id: 3, status: "active"}

# ライドシェアサービスに必要な機能一覧
## 1. ユーザー管理機能
ユーザー登録・プロフィール作成
ログイン・認証
プロフィール編集
車両情報登録（ドライバーの場合）
ユーザー評価システム
アカウント管理
## 2. 位置情報・地図機能
現在地取得（GPS連携）
目的地設定
地図表示・操作
ルート検索・表示
距離・時間計算
## 3. リクエスト管理機能
旅行リクエスト作成
リクエストのCRUD操作
リクエスト検索
リクエスト状態管理（active, matched, completed, cancelled）
リクエスト履歴表示
## 4. マッチング機能
近距離ユーザー検索アルゴリズム
マッチング候補抽出
マッチングレコード作成
マッチング状態管理
ルート最適化
## 5. 通知システム
プッシュ通知機能
マッチング通知
ステータス更新通知
キャンセル通知
リマインダー通知
## 6. 承認・拒否機能
マッチング詳細表示
承認/拒否インターフェース
部分承認状態管理
双方承認完了処理
マッチング成立通知
## 7. 旅行実行機能
リアルタイム位置共有
ナビゲーション
到着予定時刻表示
現在状況更新
緊急連絡機能
## 8. 旅行完了機能
完了報告インターフェース
完了確認プロセス
評価・レビュー入力
完了記録保存
次回予約提案
## 9. キャンセル処理機能
キャンセルインターフェース
キャンセル理由入力
関連リクエスト状態更新
代替マッチング提案
キャンセル履歴管理
## 10. 履歴管理機能
マッチング履歴記録
状態変更履歴保存
履歴検索・表示
レポート生成
問題解決のための履歴追跡
## 11. 支払い機能
料金計算
決済処理
領収書発行
支払い履歴管理
分割支払い
## 12. セキュリティ・プライバシー機能
データ暗号化
個人情報保護
位置情報アクセス制限
不正利用検知
セキュリティ監査
## 13. コミュニケーション機能
ユーザー間チャット
グループチャット
音声通話
通知設定
メッセージ履歴
## 14. 管理者機能
ユーザー管理
システム監視
統計情報収集
問題解決支援
サービス設定管理